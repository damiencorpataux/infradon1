<!DOCTYPE html>
<html>
    <head>
        <title>Âµessenger</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            :root {
               --brand: PaleVioletRed;
            }
            .brand {
                color: var(--brand);
            }
        </style>
    </head>
    <body>
        <div class="container py-4 px-4 px-md-0">
            <div class="row">
                <div class="col">
                    <h1>
                        <i class="brand pe-auto" data-feather="activity" stroke-width="3" width="48" height="58" style="position:relative; top: -3px; left:-3px"></i>
                        Âµessenger
                    </h1>
                </div>
                <div class="col text-end">
                    <strong class="current-user me-1"></strong>
                    <i class="brand" data-feather="user" stroke-width="3"></i>
                </div>
            </div>
            <p>
                A <strong>microscopic messaging system</strong>.
            </p>
            <hr class="my-4">

            <div id="umessage-ui">

                <div id="status" class="alert alert-info">
                    Hello ðŸ‘‹ ! Please log in.
                </div>

                <div class="row">
                    <div class="col-sm-9 mb-3">
                        <h2>Âµessages</h2>
                        <div class="card">
                            <div id="in-messages" class="card-body" style="max-height:300px;overflow:auto;">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                        <div id="in-messages" class="mb-3"></div>
                        <h5>Send your Âµessage, <span class="current-user">user</span> !</h5>
                        <form onsubmit="return false" autocomplete="off">
                            <select id="out-contact" class="form-select"></select>
                            <input name="out-message" type="text" class="form-control" placeholder="ðŸ“¨ Type your message...">
                            <button name="send-message" type="submit" class="btn btn-primary">Send âž¤</button>
                        </form>
                    </div>
                    <div class="col-sm-3">
                        <h2>People</h2>
                        <div class="card">
                            <div id="contacts" class="card-body" style="max-height:300px;overflow:auto;">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="mt-4 small opacity-25 text-end">
                Â© Damien Corpataux for unit
                <a href="https://github.com/damiencorpataux/infradon1">InfraDon1</a>.
            </footer>
        </div>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://unpkg.com/feather-icons"></script>
        <script>feather.replace()</script>

        <script>
            /**
             * UI Configuration, Setup & Initialisation
             * 
             * TODO: Use localStorage to remember current_user_id and out_contact.value across page-reloads.
             */
            const api_url = (window.location.href || 'http://localhost:8080').replace(/\/$/, '');
            const ui = {
                contacts: document.querySelector('#contacts'),
                out_contact: document.querySelector('#out-contact'),
                in_messages: document.querySelector('#in-messages'),
                out_message: document.querySelector('input[name=out-message]'),
                send_message: document.querySelector('button[name=send-message]'),
                current_user_displays: document.querySelectorAll('.current-user'),
                status: document.querySelector('#status')
            };
            let current_user_id = null;  // Note: The currently logged in user, this variable is usually set in login_user().
            init();

            /**
             * App initialisation.
             * 
             * Populate contacts and messages, setup user-interaction logic, and logs in the user.
             */
            function init() {
                populate_all();  // Initial population, triggers user login.
                setInterval(() => {
                    if (current_user_id) populate_all();  // Periodic re-population, to keep UI up-to-date with database (polling).
                }, 3333);
                ui.send_message.addEventListener('click', send_message);
                ui.send_message.addEventListener('submit', send_message);
                ui.out_message.focus();
                // Iteration 2: Allow user to login (insecure, because real authentication)
                // for (current_user_display of ui.current_user_displays) {
                //     current_user_display.style.cursor = 'pointer';
                //     current_user_display.style.textDecoration = 'underline';
                //     current_user_display.addEventListener('click', login_user);
                // }
            }

            /**
             * Populate contacts and messages.
             * 
             * Asks for login if user is not yet logged in.
             * This function is idempotent: calling it subsequently results in replaing the data in UI.
             */
             function populate_all() {
                login_user()
                    .then(() => populate_contacts())
                    .then(() => populate_messages());
                // populate_contacts().then(() => {if (notify) set_status('Ready !', 'success')});
                // populate_messages().then(() => {if (notify) set_status('Ready !', 'success')});
            }

            async function login_user() {
                while (!current_user_id) {
                    set_status('Hello ðŸ‘‹ ! Please log in.', 'info');
                    console.info('current_user_id', current_user_id);
                    let user_name = null;
                    while (!user_name) user_name = prompt('Who are you ? Enter your name...');
                    console.info('Logging in', user_name);
                    response = await fetchRetry(`${api_url}/api/contacts`, {
                        method: 'GET'
                    });
                    const contacts = await response.json();
                    console.info('Contacts', contacts);
                    // Check if given name exists in contacts
                    const remove_accents = str => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');  // Remove accents from string, see: https://www.30secondsofcode.org/js/s/remove-accents/
                    const existing_contacts = contacts.filter((contact) => remove_accents(contact.name.toUpperCase()) == remove_accents(user_name.toUpperCase()));
                    console.info('Found contacts', existing_contacts)
                    if (existing_contacts.length < 1) {
                        console.info('No user matching name', user_name);
                        alert(`Sorry, we have no user with name: ${user_name}`);
                    }
                    if (existing_contacts.length > 1) {
                        console.error('Multiple contacts existing in database with name', user_name, existing_contacts);
                        const message = `We have a problem: there is ${existing_contacts.length} contacts matching name '${user_name}' in database (${existing_contacts.map(c => c.name).join(', ')})`;
                        alert(message);
                    }
                    if (existing_contacts.length == 1) {
                        set_status(`ðŸ‘‹ Welcome <strong>${existing_contacts[0].name}<strong> !`, 'success');
                        current_user_id = existing_contacts[0].id;  // Leaving with variable current_user_id set.
                    }
                }
            }

            /**
             * Populate contacts list and dropdown.
             * 
             * This function is idempotent: calling it subsequently results in replaing the data in UI.
             */
            function populate_contacts() {
                if (!current_user_id) {
                    set_status('Please login first !', 'warning');
                    return;
                }
                // set_status('Refreshing contacts...', 'info', false);
                return fetchRetry(`${api_url}/api/contacts`, {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(contacts => {
                    // Populate contact drop-down
                    const selected_contact = ui.out_contact.value;
                    console.debug('Received messages', JSON.stringify(contacts));
                    const status_icon = {
                        1: 'ðŸŸ¢',
                        2: 'âšª',
                        3: 'ðŸ”µ'
                    };
                    ui.out_contact.innerHTML = '<option value="">Select a contact</option>';
                    for (contact of contacts) {
                        if (contact.id != current_user_id) {
                            console.debug(contact)
                            ui.out_contact.innerHTML += `
                                <option value="${contact.id}">
                                    ðŸ‘‹ ${status_icon[contact.status_id]} ${contact.name}
                                </option>`;
                        }
                    }
                    ui.out_contact.value = selected_contact || ui.out_contact.options[1].value;
                    // Populate contacts list
                    const status_color = {
                        1: 'success',
                        2: 'secondary',
                        3: 'info'
                    };
                    ui.contacts.innerHTML = '';
                    for (contact of contacts) {
                        ui.contacts.innerHTML += `
                            <div data-umsg-contact-id="${contact.id}">
                                <small>ðŸ‘‹</small>
                                <strong>${contact.name}</strong>
                                <small class="badge p-0 text-secondary">${contact.id == current_user_id ? '(you)' : ''}</small>
                                &middot;
                                <span class="badge p-0 text-${status_color[contact.status_id]}">
                                    ${contact.status_name}
                                </span>
                            </div>`;
                    }
                    for (contact_dom of ui.contacts.querySelectorAll('[data-umsg-contact-id]')) {
                        contact_dom.addEventListener('click', (event) => {
                            console.info(event.target, event.currentTarget.getAttribute('data-umsg-contact-id'))
                            ui.out_contact.value = event.currentTarget.getAttribute('data-umsg-contact-id');
                        });
                        contact_dom.style.cursor = 'pointer';
                    }
                    // Populate current user name
                    const current_user_name = contacts.filter((contact) => contact.id == current_user_id).pop().name;
                    for (current_user_display of ui.current_user_displays) {
                        current_user_display.innerHTML = current_user_name;
                    }
                    // set_status('Ready !', 'success');
                });
            }

            /**
             * Populate messages.
             * 
             * The user must be logged in (usually managed by populate_all()).
             * This function is idempotent: calling it subsequently results in replaing the data in UI.
             */
            let last_messages = {};
            function populate_messages() {
                if (!current_user_id) {
                    set_status('Please login first !', 'warning');
                    return;
                }
                // Populate messages
                // set_status('Refreshing messages...', 'info', false);
                return fetchRetry(`${api_url}/api/messages`, {
                    method: 'GET'
                })
                .then(response => {
                    return response.json();
                })
                .then(messages => {
                    console.debug('Received messages', JSON.stringify(messages));
                    // Notify new message
                    const json = JSON.stringify(messages);
                    if (json != last_messages && messages[messages.length-1].contact_source_id != current_user_id) {
                        set_status('New message !', 'warning');
                    }
                    last_messages = json;
                    // Populate messages
                    ui.in_messages.innerHTML = '';
                    for (message of messages) {
                        console.debug(message)
                        ui.in_messages.innerHTML += `
                            <div title="${message.date}" class="mb-1">
                                <strong class="text-dark">${message.contact_source_name}</strong>
                                <span class="text-secondary">â†’</span>
                                <strong class="text-dark">${message.contact_destination_name}</strong>
                                &middot;
                                <span>${message.content}</span>
                                <div><small class="text-secondary">${message.creation}</small></div>
                            </div>`;
                    }
                    ui.in_messages.scrollTop = ui.in_messages.scrollHeight;
                    // set_status('Ready !', 'success');
                });
            }

            /**
             * Send the message in text field to contact in drop-down field.
             * 
             * This function is idempotent: calling it subsequently results in replaing the data in UI.
             */
            function send_message() {
                const contact_source_id = current_user_id;
                const contact_destination_id = ui.out_contact.value;
                const content = ui.out_message.value;
                const button_value = ui.send_message.innerHTML;
                console.info('Sending message...', contact_source_id, contact_destination_id, content);
                if (!contact_destination_id) {
                    set_status('Please select a contact for your message !', 'warning');
                    return;
                }
                if (!content) {
                    set_status('Please type a message !', 'warning');
                    return;
                }
                ui.send_message.disabled = true;
                ui.send_message.innerHTML= '<div class="spinner-border" role="status"></div>';
                return fetchRetry(`${api_url}/api/messages/${contact_source_id}/${contact_destination_id}/${content}`, {
                    method: 'POST'
                })
                // .then(response => response.json())
                .then(response => {
                    ui.out_message.value = '';
                    populate_messages();
                    set_status('Message sent !', 'success');
                })
                .catch(error => {
                    console.error(error);
                    set_status('Error, message was not sent.', 'danger');
                })
                .finally(error => {
                    ui.send_message.disabled = false;
                    ui.send_message.innerHTML= button_value;
                });

            }

            /**
             * Utility: Update status message.
             * https://stackoverflow.com/a/76140785/1300775
             */
            function set_status(text, cls, clear) {
                clear = clear === undefined ? true : clear;
                cls = cls || 'secondary';
                if (clear) ui.status.innerHTML = text;
                else ui.status.innerHTML += ` ${text}`;
                ui.status.classList.value = `alert alert-${cls}`;
            }

            /**
             * Utility: Fetch API with retry.
             * https://stackoverflow.com/a/76140785/1300775
             * 
             * We need this because out HTTP Service implementation is very basic.
             */
            async function fetchRetry(...args) {
                const MAX_NB_RETRY = 6;
                const RETRY_DELAY_MS = 333;
                let retryLeft = MAX_NB_RETRY;
                while (retryLeft > 0){
                    try {
                        console.debug(`Fetching ${retryLeft<MAX_NB_RETRY ? ' retry' : ''}`, MAX_NB_RETRY-retryLeft, `max ${MAX_NB_RETRY}*${RETRY_DELAY_MS}ms`, args);
                        return await fetch(...args);
                    }
                    catch (error) { 
                        if (!retryLeft) console.error(error);
                        await sleep(RETRY_DELAY_MS)
                    }
                    finally {
                        retryLeft -= 1;
                    }
                }
                throw new Error(`Too many retries (${MAX_NB_RETRY} * ${RETRY_DELAY_MS}ms)`);

                function sleep(delay){
                    return new Promise((resolve) => setTimeout(resolve, delay));
                }
            }

        </script>
    </body>
</html>
