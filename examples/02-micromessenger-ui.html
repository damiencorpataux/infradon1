<!DOCTYPE html>
<html>
    <head>
        <title>µessenger</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            :root {
               --brand: PaleVioletRed;
            }
            .brand {
                color: var(--brand);
            }
        </style>
    </head>
    <body>
        <div class="container py-4 px-4 px-md-0">
            <h1>
                <i class="brand pe-auto" data-feather="activity" stroke-width="3" width="48" height="58" style="position:relative; top: -3px; left:-3px"></i>
                µessenger
            </h1>
            <p>
                A <strong>microscopic messaging system</strong>.
            </p>
            <hr class="my-4">

            <div id="umessage-ui">

                <div id="status" class="alert alert-info">
                    <div class="spinner-border" role="status"></div>
                    Loading...
                </div>

                <div class="row">
                    <div class="col-sm-9 mb-3">
                        <h2>µessages</h2>
                        <div class="card">
                            <div id="in-messages" class="card-body" style="max-height:300px;overflow:auto;">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                        <div id="in-messages" class="mb-3"></div>
                        <h5>Send your µessage</h5>
                        <form onsubmit="return false">
                            <select id="out-contact" class="form-select"></select>
                            <input name="out-message" type="text" class="form-control" placeholder="Type your message...">
                            <button name="send-message" type="submit" class="btn btn-primary">Send ➤</button>
                        </form>
                    </div>
                    <div class="col-sm-3">
                        <h2>People</h2>
                        <div class="card">
                            <div id="contacts" class="card-body" style="max-height:300px;overflow:auto;">
                                <div class="spinner-border" role="status"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="mt-4 small opacity-25 text-end">
                © Damien Corpataux for unit
                <a href="https://github.com/damiencorpataux/infradon1">InfraDon1</a>.
            </footer>
        </div>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://unpkg.com/feather-icons"></script>
        <script>feather.replace()</script>

        <script>
            /**
             * UI Setup & Controller
             */
            const api_url = (window.location.href || 'http://localhost:8080').replace(/\/$/, '')
            const ui = {
                contacts: document.querySelector('#contacts'),
                out_contact: document.querySelector('#out-contact'),
                in_messages: document.querySelector('#in-messages'),
                out_message: document.querySelector('input[name=out-message]'),
                send_message: document.querySelector('button[name=send-message]'),
                status: document.querySelector('#status')
            };

            // App initialisation
            populate_all(true);
            setInterval(populate_all, 3333);
            ui.send_message.addEventListener('click', send_message);
            ui.send_message.addEventListener('submit', send_message);

            function populate_all(notify) {
                populate_contacts().then(() => {if (notify) set_status('Ready !', 'success')});
                populate_messages().then(() => {if (notify) set_status('Ready !', 'success')});
            }
            
            function populate_contacts() {
                const status_color = {
                    1: 'success',
                    2: 'secondary',
                    3: 'info'
                };
                // set_status('Refreshing contacts...', 'info', false);
                return fetchRetry(`${api_url}/api/contacts`, {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(response => {
                    const selected = ui.out_contact.value;
                    console.debug('Received messages', JSON.stringify(response));
                    ui.out_contact.innerHTML = '<option value="">Select a contact</option>';
                    for (contact of response) {
                        console.debug(contact)
                        ui.out_contact.innerHTML += `<option value="${contact.id}">${contact.name} (${contact.status_name})`;
                    }
                    ui.contacts.innerHTML = '';
                    for (contact of response) {
                        ui.contacts.innerHTML += `
                            <div>
                                ${contact.name}
                                <span class="badge text-primary text-${status_color[contact.status_id]}">${contact.status_name}</span>
                            </div>`;
                    }
                    ui.out_contact.value = selected;
                    // set_status('Ready !', 'success');
                });
            }

            let last_messages = {};
            function populate_messages() {
                // set_status('Refreshing messages...', 'info', false);
                return fetchRetry(`${api_url}/api/messages`, {
                    method: 'GET'
                })
                .then(response => {
                    return response.json();
                })
                .then(response => {
                    console.debug('Received messages', JSON.stringify(response));
                    // Notify new message
                    const json = JSON.stringify(response);
                    if (json != last_messages && response[response.length-1].contact_source_id != 1) {  // FIXME: Hardcoded
                        set_status('New message !', 'warning');
                    }
                    last_messages = json;
                    // Populate messages
                    ui.in_messages.innerHTML = '';
                    for (message of response) {
                        console.debug(message)
                        ui.in_messages.innerHTML += `
                            <div title="${message.date}" class="mb-1">
                                <strong class="text-dark">${message.contact_source_name}</strong>
                                &middot;
                                <span>${message.content}</span>
                                <div><small class="text-secondary">${message.creation}</small></div>
                            </div>`;
                    }
                    ui.in_messages.scrollTop = ui.in_messages.scrollHeight;
                    // set_status('Ready !', 'success');
                });
            }

            function send_message() {
                const contact_source_id = '1';   // FIXME: Hardcoded
                const contact_destination_id = ui.out_contact.value;
                const content = ui.out_message.value;
                const button_value = ui.send_message.innerHTML;
                console.debug('Sending message...', contact_source_id, contact_destination_id, content);
                if (!contact_destination_id) {
                    set_status('Please select a contact for your message !', 'warning');
                    return;
                }
                if (!content) {
                    set_status('Please type a message !', 'warning');
                    return;
                }
                ui.send_message.disabled = true;
                ui.send_message.innerHTML= '<div class="spinner-border" role="status"></div>';
                return fetchRetry(`${api_url}/api/messages/${contact_source_id}/${contact_destination_id}/${content}`, {
                    method: 'POST'
                })
                // .then(response => response.json())
                .then(response => {
                    ui.out_message.value = '';
                    populate_messages();
                    set_status('Message sent !', 'success');
                })
                .catch(error => {
                    console.error(error);
                    set_status('Error, message was not sent.', 'danger');
                })
                .finally(error => {
                    ui.send_message.disabled = false;
                    ui.send_message.innerHTML= button_value;
                });

            }

            /**
             * Utility: Update status message.
             * https://stackoverflow.com/a/76140785/1300775
             */
            function set_status(text, cls, clear) {
                clear = clear === undefined ? true : clear;
                cls = cls || 'secondary';
                if (clear) ui.status.innerHTML = text;
                else ui.status.innerHTML += ` ${text}`;
                ui.status.classList.value = `alert alert-${cls}`;
            }

            /**
             * Utility: Fetch API with retry.
             * https://stackoverflow.com/a/76140785/1300775
             * 
             * We need this because out HTTP Service implementation is very basic.
             */
            async function fetchRetry(...args) {
                const MAX_NB_RETRY = 6;
                const RETRY_DELAY_MS = 333;
                let retryLeft = MAX_NB_RETRY;
                while (retryLeft > 0){
                    try {
                        console.debug(`Fetching ${retryLeft<MAX_NB_RETRY ? ' retry' : ''}`, MAX_NB_RETRY-retryLeft, `max ${MAX_NB_RETRY}*${RETRY_DELAY_MS}ms`, args);
                        return await fetch(...args);
                    }
                    catch (error) { 
                        if (!retryLeft) console.error(error);
                        await sleep(RETRY_DELAY_MS)
                    }
                    finally {
                        retryLeft -= 1;
                    }
                }
                throw new Error(`Too many retries (${MAX_NB_RETRY} * ${RETRY_DELAY_MS}ms)`);

                function sleep(delay){
                    return new Promise((resolve) => setTimeout(resolve, delay));
                }
            }

        </script>
    </body>
</html>
